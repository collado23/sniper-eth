import os
import time
import pandas as pd
import pandas_ta as ta
from binance.client import Client

# CONFIGURACIÃ“N DE SEGURIDAD
API_KEY = os.getenv('BINANCE_API_KEY')
API_SECRET = os.getenv('BINANCE_API_SECRET')
client = Client(API_KEY, API_SECRET)

SYMBOL = 'ETHUSDT'
LEVERAGE = 10

def obtener_indicadores():
    # Pedimos 100 velas de 5 min para que los indicadores sean precisos
    klines = client.futures_klines(symbol=SYMBOL, interval='5m', limit=100)
    df = pd.DataFrame(klines, columns=['time', 'open', 'high', 'low', 'close', 'vol', 'close_time', 'qav', 'num_trades', 'taker_base', 'taker_quote', 'ignore'])
    df[['high', 'low', 'close', 'vol']] = df[['high', 'low', 'close', 'vol']].astype(float)
    
    # ADX (Fuerza de tendencia)
    adx_df = ta.adx(df['high'], df['low'], df['close'], length=14)
    adx = adx_df['ADX_14'].iloc[-1]
    
    # StochRSI (Puntos de giro)
    stoch_rsi = ta.stochrsi(df['close'], length=14, rsi_length=14, k=3, d=3)
    stoch_k = stoch_rsi.iloc[-1]['STOCHRSIk_14_14_3_3']
    
    precio_actual = df['close'].iloc[-1]
    return adx, stoch_k, precio_actual

def ejecutar_quantum():
    print("ðŸ”± ALE IA QUANTUM ACTIVADO - Modo Sniper 0.10%")
    client.futures_change_leverage(symbol=SYMBOL, leverage=LEVERAGE)

    while True:
        try:
            # 1. Estado de la cuenta y posiciÃ³n
            posicion = client.futures_position_information(symbol=SYMBOL)[0]
            amt = float(posicion['positionAmt'])
            adx, stoch_k, precio = obtener_indicadores()

            # --- LÃ“GICA DE CIERRE (Si hay operaciÃ³n abierta) ---
            if amt != 0:
                entry_price = float(posicion['entryPrice'])
                pnl = float(posicion['unRealizedProfit'])
                roi = (pnl / (abs(amt) * entry_price / LEVERAGE)) * 100
                
                # CIERRE SNIPER: Si el ROI es bueno y el StochRSI se agota
                if (amt > 0 and stoch_k > 80) or (amt < 0 and stoch_k < 20):
                    print(f"âœ… Cerrando por agotamiento. ROI: {roi:.2f}%")
                    client.futures_create_order(symbol=SYMBOL, side='SELL' if amt > 0 else 'BUY', type='MARKET', quantity=abs(amt))
                
                # CIERRE POR SEGURIDAD: Si la tendencia (ADX) se muere
                elif roi > 0.5 and adx < 18:
                    print("âš ï¸ Tendencia dÃ©bil. Asegurando centavos.")
                    client.futures_create_order(symbol=SYMBOL, side='SELL' if amt > 0 else 'BUY', type='MARKET', quantity=abs(amt))

            # --- LÃ“GICA DE APERTURA (Si NO hay operaciÃ³n abierta) ---
            else:
                balance = float([b['balance'] for b in client.futures_account_balance() if b['asset'] == 'USDT'][0])
                # InterÃ©s Compuesto 20%
                monto_usdt = balance * 0.20
                cantidad_eth = round((monto_usdt * LEVERAGE) / precio, 3)

                # Solo entra si hay tendencia (ADX > 22)
                if adx > 22:
                    if stoch_k < 20: # LONG
                        print(f"ðŸš€ Iniciando COMPRA (Long) en {precio}")
                        client.futures_create_order(symbol=SYMBOL, side='BUY', type='MARKET', quantity=cantidad_eth)
                    elif stoch_k > 80: # SHORT
                        print(f"ðŸ”» Iniciando VENTA (Short) en {precio}")
                        client.futures_create_order(symbol=SYMBOL, side='SELL', type='MARKET', quantity=cantidad_eth)

            time.sleep(10) # Respiro para no saturar Binance

        except Exception as e:
            print(f"Esperando seÃ±al... (Error: {e})")
            time.sleep(20)

if __name__ == "__main__":
    ejecutar_quantum()
